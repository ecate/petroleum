<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>BitmaskAttributes::Definition</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            BitmaskAttributes::Definition 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/bitmask_attributes/definition_rb.html">lib/bitmask_attributes/definition.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-create_attribute_methods_on">create_attribute_methods_on</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_convenience_class_method_on">create_convenience_class_method_on</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_convenience_instance_methods_on">create_convenience_instance_methods_on</a>,
              </li>
            
              
              <li>
                <a href="#method-i-create_scopes_on">create_scopes_on</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-generate_bitmasks_on">generate_bitmasks_on</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-install_on">install_on</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-override">override</a>,
              </li>
            
              
              <li>
                <a href="#method-i-override_getter_on">override_getter_on</a>,
              </li>
            
              
              <li>
                <a href="#method-i-override_setter_on">override_setter_on</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>V</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-validate_for">validate_for</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>attribute</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>extension</td>
            <td class='attr-desc'></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>values</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <a name="method-c-new"></a><b>new</b>(attribute, values=[], &amp;extension)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 5</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span>(<span class="ruby-identifier">attribute</span>, <span class="ruby-identifier">values</span>=[], &amp;<span class="ruby-identifier">extension</span>)
  <span class="ruby-ivar">@attribute</span> = <span class="ruby-identifier">attribute</span>
  <span class="ruby-ivar">@values</span> = <span class="ruby-identifier">values</span>
  <span class="ruby-ivar">@extension</span> = <span class="ruby-identifier">extension</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-install_on">
            
              <a name="method-i-install_on"></a><b>install_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-install_on_source')" id="l_method-i-install_on_source">show</a>
                
              </p>
              <div id="method-i-install_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 11</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">install_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">validate_for</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">generate_bitmasks_on</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">override</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">create_convenience_class_method_on</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">create_convenience_instance_methods_on</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">create_scopes_on</span> <span class="ruby-identifier">model</span>
  <span class="ruby-identifier">create_attribute_methods_on</span> <span class="ruby-identifier">model</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
              
      <div class="sectiontitle">Instance Private methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-create_attribute_methods_on">
            
              <a name="method-i-create_attribute_methods_on"></a><b>create_attribute_methods_on</b>(model)
            
          </div>
          
          
            <div class="description">
              <p>Returns the defined values as an Array.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-create_attribute_methods_on_source')" id="l_method-i-create_attribute_methods_on_source">show</a>
                
              </p>
              <div id="method-i-create_attribute_methods_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 65</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">create_attribute_methods_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    def self.values_for_#{attribute}      # def self.values_for_numbers
      #{values}                           #   [:one, :two, :three]
    end                                   # end
  )</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-create_convenience_class_method_on">
            
              <a name="method-i-create_convenience_class_method_on"></a><b>create_convenience_class_method_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-create_convenience_class_method_on_source')" id="l_method-i-create_convenience_class_method_on_source">show</a>
                
              </p>
              <div id="method-i-create_convenience_class_method_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 73</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">create_convenience_class_method_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    def self.bitmask_for_#{attribute}(*values)
      values.inject(0) do |bitmask, value|
        unless (bit = bitmasks[:#{attribute}][value])
          raise ArgumentError, &quot;Unsupported value for #{attribute}: \#{value.inspect}&quot;
        end
        bitmask | bit
      end
    end
  )</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-create_convenience_instance_methods_on">
            
              <a name="method-i-create_convenience_instance_methods_on"></a><b>create_convenience_instance_methods_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-create_convenience_instance_methods_on_source')" id="l_method-i-create_convenience_instance_methods_on_source">show</a>
                
              </p>
              <div id="method-i-create_convenience_instance_methods_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 86</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">create_convenience_instance_methods_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
      def #{attribute}_for_#{value}?                  
        self.#{attribute}?(:#{value})
      end
    )</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    def #{attribute}?(*values)
      if !values.blank?
        values.all? do |value|
          self.#{attribute}.include?(value)
        end
      else
        self.#{attribute}.present?
      end
    end
  )</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-create_scopes_on">
            
              <a name="method-i-create_scopes_on"></a><b>create_scopes_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-create_scopes_on_source')" id="l_method-i-create_scopes_on_source">show</a>
                
              </p>
              <div id="method-i-create_scopes_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 107</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">create_scopes_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    scope :with_#{attribute},
      proc { |*values|
        if values.blank?
          where('#{attribute} &gt; 0 OR #{attribute} IS NOT NULL')
        else
          sets = values.map do |value|
            mask = #{model}.bitmask_for_#{attribute}(value)
            &quot;#{attribute} &amp; \#{mask} &lt;&gt; 0&quot;
          end
          where(sets.join(' AND '))
        end
      }
    scope :without_#{attribute}, 
      proc { |value| 
        if value
          mask = #{model}.bitmask_for_#{attribute}(value)
          where(&quot;#{attribute} IS NULL OR #{attribute} &amp; ? = 0&quot;, mask)
        else
          where(&quot;#{attribute} IS NULL OR #{attribute} = 0&quot;)
        end              
        }                    
    
    scope :no_#{attribute}, where(&quot;#{attribute} = 0 OR #{attribute} IS NULL&quot;)
    
    scope :with_any_#{attribute},
      proc { |*values|
        if values.blank?
          where('#{attribute} &gt; 0 OR #{attribute} IS NOT NULL')
        else
          sets = values.map do |value|
            mask = #{model}.bitmask_for_#{attribute}(value)
            &quot;#{attribute} &amp; \#{mask} &lt;&gt; 0&quot;
          end
          where(sets.join(' OR '))
        end
      }
  )</span>
  <span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
      scope :#{attribute}_for_#{value},
            where('#{attribute} &amp; ? &lt;&gt; 0', #{model}.bitmask_for_#{attribute}(:#{value}))
    )</span>
  <span class="ruby-keyword">end</span>      
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-generate_bitmasks_on">
            
              <a name="method-i-generate_bitmasks_on"></a><b>generate_bitmasks_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-generate_bitmasks_on_source')" id="l_method-i-generate_bitmasks_on_source">show</a>
                
              </p>
              <div id="method-i-generate_bitmasks_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 34</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">generate_bitmasks_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">bitmasks</span>[<span class="ruby-identifier">attribute</span>] = <span class="ruby-constant">HashWithIndifferentAccess</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mapping</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">values</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">value</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">mapping</span>[<span class="ruby-identifier">value</span>] = <span class="ruby-number">0b1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">index</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-override">
            
              <a name="method-i-override"></a><b>override</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-override_source')" id="l_method-i-override_source">show</a>
                
              </p>
              <div id="method-i-override_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 42</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">override</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">override_getter_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">override_setter_on</span>(<span class="ruby-identifier">model</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-override_getter_on">
            
              <a name="method-i-override_getter_on"></a><b>override_getter_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-override_getter_on_source')" id="l_method-i-override_getter_on_source">show</a>
                
              </p>
              <div id="method-i-override_getter_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">override_getter_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    def #{attribute}
      @#{attribute} ||= BitmaskAttributes::ValueProxy.new(self, :#{attribute}, &amp;self.class.bitmask_definitions[:#{attribute}].extension)
    end
  )</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-override_setter_on">
            
              <a name="method-i-override_setter_on"></a><b>override_setter_on</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-override_setter_on_source')" id="l_method-i-override_setter_on_source">show</a>
                
              </p>
              <div id="method-i-override_setter_on_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 55</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">override_setter_on</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-identifier">model</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-node">%Q(
    def #{attribute}=(raw_value)
      values = raw_value.kind_of?(Array) ? raw_value : [raw_value]
      self.#{attribute}.replace(values.reject(&amp;:blank?))
    end
  )</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-validate_for">
            
              <a name="method-i-validate_for"></a><b>validate_for</b>(model)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-validate_for_source')" id="l_method-i-validate_for_source">show</a>
                
              </p>
              <div id="method-i-validate_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/bitmask_attributes/definition.rb, line 23</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">validate_for</span>(<span class="ruby-identifier">model</span>)
  <span class="ruby-comment"># The model cannot be validated if it is preloaded and the attribute/column is not in the</span>
  <span class="ruby-comment"># database (the migration has not been run) or table doesn't exist. This usually</span>
  <span class="ruby-comment"># occurs in the 'test' and 'production' environment or during migration.</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-constant">Rails</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">cache_classes</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">model</span>.<span class="ruby-identifier">table_exists?</span>
 
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">columns</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">col</span><span class="ruby-operator">|</span> <span class="ruby-identifier">col</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">attribute</span>.<span class="ruby-identifier">to_s</span> }
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;`#{attribute}' is not an attribute of `#{model}'&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>
    </div>
  </body>
</html>    